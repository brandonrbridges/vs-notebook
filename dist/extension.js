"use strict";var W=Object.create;var L=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var Y=(h,s)=>{for(var o in s)L(h,o,{get:s[o],enumerable:!0})},U=(h,s,o,l)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of _(s))!A.call(h,t)&&t!==o&&L(h,t,{get:()=>s[t],enumerable:!(l=O(s,t))||l.enumerable});return h};var I=(h,s,o)=>(o=h!=null?W(V(h)):{},U(s||!h||!h.__esModule?L(o,"default",{value:h,enumerable:!0}):o,h)),q=h=>U(L({},"__esModule",{value:!0}),h);var z={};Y(z,{activate:()=>H,deactivate:()=>Q});module.exports=q(z);var e=I(require("vscode")),v=I(require("path")),g=I(require("fs"));var d=I(require("vscode")),N=I(require("fs")),T=I(require("path")),j=class{constructor(s,o){this.workspaceRoot=s;this.isGlobal=o}_onDidChangeTreeData=new d.EventEmitter;onDidChangeTreeData=this._onDidChangeTreeData.event;refresh(){this._onDidChangeTreeData.fire()}getTreeItem(s){return s}getChildren(s){if(!this.workspaceRoot)return d.window.showInformationMessage("No workspace open"),Promise.resolve([]);let o=this.isGlobal?this.workspaceRoot:T.join(this.workspaceRoot,".vs-notebook");if(!N.existsSync(o))return Promise.resolve([]);if(s&&s instanceof F)return Promise.resolve(s.children);let t=N.readdirSync(o).filter(f=>f.endsWith(".md")).map(f=>{let n=T.join(o,f);return new S(f,n)}),i=d.workspace.getConfiguration("vs-notebook").get("groupBy","none");if(this.isGlobal&&i==="file"&&(i="tag"),i==="none")return Promise.resolve(t);let r=this.groupNotes(t,i);return Promise.resolve(r)}async search(s){if(!this.workspaceRoot)return[];let o=T.join(this.workspaceRoot,".vs-notebook");if(!N.existsSync(o))return[];let l=N.readdirSync(o).filter(i=>i.endsWith(".md")),t=s.toLowerCase(),a=[];for(let i of l){let r=T.join(o,i);N.readFileSync(r,"utf-8").toLowerCase().includes(t)&&a.push(new S(i,r))}return a}groupNotes(s,o){switch(o){case"file":return this.groupByFile(s);case"tag":return this.groupByTag(s);default:return s}}groupByFile(s){let o=new Map;for(let t of s){let a=S.readFrontmatter(t.fullPath),i=a.file?T.basename(a.file):"Unknown File";o.has(i)||o.set(i,[]),o.get(i).push(t)}let l=[];for(let[t,a]of o)l.push(new F(t,a,"file"));return l.sort((t,a)=>t.label.localeCompare(a.label))}groupByTag(s){let o=new Map;for(let t of s){let i=S.readFrontmatter(t.fullPath).tags?.split(",").map(f=>f.trim()).filter(Boolean)??[],r=i.length>0?i[0]:"Untagged";r||(r="Untagged"),r=r.charAt(0).toUpperCase()+r.slice(1),o.has(r)||o.set(r,[]),o.get(r).push(t)}let l=[];for(let[t,a]of o)l.push(new F(t,a,"tag"));return l.sort((t,a)=>t.label.localeCompare(a.label))}},F=class extends d.TreeItem{constructor(o,l,t){super(o,d.TreeItemCollapsibleState.Expanded);this.label=o;this.children=l;this.groupType=t;this.tooltip=`${this.children.length} note${this.children.length!==1?"s":""}`,this.description=`${this.children.length}`,t==="file"?this.iconPath=new d.ThemeIcon("file"):this.iconPath=new d.ThemeIcon("tag"),this.contextValue="groupItem"}},S=class h extends d.TreeItem{constructor(o,l){super(o,d.TreeItemCollapsibleState.None);this.label=o;this.fullPath=l;let t=h.readFrontmatter(l),a=t.tags?.split(",").map(i=>i.trim())??[];a.includes("feature")?this.iconPath=new d.ThemeIcon("star",new d.ThemeColor("charts.green")):a.includes("bug")?this.iconPath=new d.ThemeIcon("bug",new d.ThemeColor("errorForeground")):a.includes("todo")?this.iconPath=new d.ThemeIcon("checklist",new d.ThemeColor("charts.yellow")):a.includes("refactor")?this.iconPath=new d.ThemeIcon("tools",new d.ThemeColor("charts.blue")):this.iconPath=new d.ThemeIcon("note"),this.tooltip=`${o}
${t.file??""} : ${t.line??""}${t.tags?`
Tags: `+t.tags:""}`,this.description=t.file?`${T.basename(t.file)} ${t.tags?` \u2022 ${t.tags}`:""}`:"",this.command={command:"vs-notebook.openNote",title:"Open Note",arguments:[this.fullPath]},this.resourceUri=d.Uri.file(this.fullPath),this.contextValue="noteItem"}static readFrontmatter(o){try{let t=N.readFileSync(o,"utf-8").match(/^---\n([\s\S]+?)\n---/);if(t){let i=t[1].split(`
`),r={};for(let f of i){let[n,...c]=f.split(":");r[n.trim()]=c.join(":").trim()}return{file:r.file,line:r.line,tags:r.tags}}}catch(l){console.error("Failed to read frontmatter:",l)}return{}}};var $=I(require("vscode")),E=I(require("fs")),D=I(require("path")),R=class{constructor(s){this.workspaceRoot=s;this.refreshNotes()}_onDidChangeCodeLenses=new $.EventEmitter;onDidChangeCodeLenses=this._onDidChangeCodeLenses.event;notes={};refreshNotes(){this.notes={};let s=D.join(this.workspaceRoot,".vs-notebook");if(!E.existsSync(s))return;let o=E.readdirSync(s).filter(l=>l.endsWith(".md"));for(let l of o){let t=D.join(s,l),i=E.readFileSync(t,"utf8").match(/^---\n([\s\S]+?)\n---/);if(!i)continue;let r=Object.fromEntries(i[1].split(`
`).map(f=>{let[n,...c]=f.split(":");return[n.trim(),c.join(":").trim()]}));if(r.file&&r.line){let f=D.resolve(r.file),n=r.line,c=null,p=null;if(n.includes("-")){let m=n.split("-").map(u=>parseInt(u));m.length===2&&m.every(u=>!isNaN(u))&&(c=m[0]-1,p=m[1]-1)}else{let m=parseInt(n);isNaN(m)||(c=p=m-1)}c!==null&&p!==null&&(this.notes[f]||(this.notes[f]=[]),this.notes[f].push({start:c,end:p}))}}}refresh(){this.refreshNotes(),this._onDidChangeCodeLenses.fire()}provideCodeLenses(s){let o=D.resolve(s.uri.fsPath),t=(this.notes[o]??[]).reduce((i,r)=>{let f=r.start;return i[f]||(i[f]=[]),i[f].push(r),i},{}),a=[];return Object.entries(t).forEach(([i,r])=>{let f=parseInt(i),n=r.length,c=r.length===1&&r[0].start===r[0].end,p=c?`${n} note${n>1?"s":""} for this line`:`${n} note${n>1?"s":""} for lines ${r[0].start+1}-${r[0].end+1}`;a.push(new $.CodeLens(new $.Range(f,0,f,0),{title:p,command:c?"vs-notebook.openNotesForLine":"vs-notebook.openNotesForRange",arguments:c?[o,f+1]:[o,r[0].start+1,r[0].end+1]}))}),a}};function H(h){let s=e.workspace.workspaceFolders?.[0].uri.fsPath??"",o=require("os").homedir(),l=v.join(o,".vs-notebook-global"),t=new j(s,!1);e.window.registerTreeDataProvider("vs-notebook-notes",t);let a=new j(l,!0);e.window.registerTreeDataProvider("vs-notebook-notes-global",a);let i=new R(s);h.subscriptions.push(e.languages.registerCodeLensProvider({scheme:"file"},i)),e.commands.registerCommand("vs-notebook.openSettings",()=>{e.commands.executeCommand("workbench.action.openSettings","@ext:brandonbridges.vs-notebook")}),h.subscriptions.push(e.commands.registerCommand("vs-notebook.openNote",n=>{e.workspace.openTextDocument(n).then(c=>{e.window.showTextDocument(c)})}),e.commands.registerCommand("vs-notebook.refreshNotes",()=>{t.refresh(),a.refresh(),i.refresh()}));let r=e.commands.registerCommand("vs-notebook.createNote",async()=>{let n=await e.window.showInputBox({prompt:"Enter note title"});if(!n)return;let c=await e.window.showInputBox({prompt:"Enter note description"}),p=await e.window.showInputBox({prompt:"Enter tags (comma-separated, optional)"}),m=e.window.activeTextEditor,u=m?.document.uri.fsPath??"Unknown",w=m?.selection,b=`title: ${n}
file: ${u}
`;if(w?.isEmpty){let C=w.active.line+1;b+=`line: ${C}
`}else if(w){let C=w.start.line+1,G=w.end.line+1;b+=`line: ${C}-${G}
`}b+=`tags: ${p||""}`,b+=`
url: `;let P=m?m.selection.active.line+1:"Unknown",k=e.workspace.workspaceFolders;if(!k){e.window.showErrorMessage("No workspace folder found.");return}let x=k[0].uri.fsPath,y=v.join(x,".vs-notebook"),B=v.join(y,`${n.replace(/\s+/g,"-")}.md`);g.existsSync(y)||g.mkdirSync(y,{recursive:!0});let M=`---
${b}
---

${c||""}`;g.writeFileSync(B,M),e.window.showInformationMessage(`Note "${n}" created.`),e.workspace.openTextDocument(B).then(C=>{e.window.showTextDocument(C,{viewColumn:e.ViewColumn.Beside,preserveFocus:!1,preview:!1})})}),f=e.commands.registerCommand("vs-notebook.createGlobalNote",async()=>{let n=await e.window.showInputBox({prompt:"Enter global note title"});if(!n)return;let c=await e.window.showInputBox({prompt:"Enter note description"}),p=await e.window.showInputBox({prompt:"Enter tags (comma-separated, optional)"});g.existsSync(l)||g.mkdirSync(l,{recursive:!0});let m=v.join(l,`${n.replace(/\s+/g,"-")}.md`),u=`---
title: ${n}
tags: ${p||""}
url: 
---

${c||""}`;g.writeFileSync(m,u),e.window.showInformationMessage(`Global note "${n}" created.`),e.workspace.openTextDocument(m).then(w=>{e.window.showTextDocument(w,{viewColumn:e.ViewColumn.Beside,preserveFocus:!1,preview:!1})}),a.refresh()});e.commands.registerCommand("vs-notebook.deleteNote",async n=>{let c=n.fullPath;await e.window.showWarningMessage("Are you sure you want to delete this note?",{modal:!0},"Yes","No")==="Yes"&&(await e.workspace.fs.delete(e.Uri.file(c)),e.window.showInformationMessage("Note deleted"),t.refresh(),a.refresh(),i.refresh())}),e.commands.registerCommand("vs-notebook.renameNote",async n=>{let c=n.fullPath,p=v.basename(c,".md"),m=await e.window.showInputBox({prompt:"Enter new note name",value:p});if(!m||m===p)return;let u=v.join(v.dirname(c),`${m.replace(/\s+/g,"-")}.md`);await e.workspace.fs.rename(e.Uri.file(c),e.Uri.file(u)),e.window.showInformationMessage("Note renamed"),t.refresh(),a.refresh(),i.refresh()}),e.commands.registerCommand("vs-notebook.openNotesForLine",(n,c)=>{let p=v.join(s,".vs-notebook");if(!g.existsSync(p))return;let m=g.readdirSync(p).filter(u=>u.endsWith(".md")).map(u=>v.join(p,u)).filter(u=>{let b=g.readFileSync(u,"utf8").match(/^---\n([\s\S]+?)\n---/);if(!b)return!1;let P=Object.fromEntries(b[1].split(`
`).map(k=>{let[x,...y]=k.split(":");return[x.trim(),y.join(":").trim()]}));return v.resolve(P.file??"")===v.resolve(n)&&parseInt(P.line??"")===c});m.length===0?e.window.showInformationMessage("No notes found for this line."):m.forEach(u=>{e.workspace.openTextDocument(u).then(w=>e.window.showTextDocument(w,{preview:!1}))})}),e.commands.registerCommand("vs-notebook.openNotesForRange",(n,c,p)=>{let m=v.join(s,".vs-notebook");if(!g.existsSync(m))return;let u=g.readdirSync(m).filter(w=>w.endsWith(".md")).map(w=>v.join(m,w)).filter(w=>{let P=g.readFileSync(w,"utf8").match(/^---\n([\s\S]+?)\n---/);if(!P)return!1;let k=Object.fromEntries(P[1].split(`
`).map(B=>{let[M,...C]=B.split(":");return[M.trim(),C.join(":").trim()]}));if(v.resolve(k.file??"")!==v.resolve(n))return!1;let x=k.lineStart?parseInt(k.lineStart):null,y=k.lineEnd?parseInt(k.lineEnd):null;return x===null||y===null?!1:!(y<c||x>p)});u.length===0?e.window.showInformationMessage("No notes found for this code block."):u.forEach(w=>{e.workspace.openTextDocument(w).then(b=>e.window.showTextDocument(b,{preview:!1}))})}),e.workspace.onDidSaveTextDocument(n=>{n.fileName.includes(".vs-notebook")&&(t.refresh(),a.refresh(),i.refresh())}),e.workspace.onDidChangeConfiguration(n=>{(n.affectsConfiguration("vs-notebook.groupBy")||n.affectsConfiguration("vs-notebook.tagIcons"))&&(t.refresh(),a.refresh())}),h.subscriptions.push(r),h.subscriptions.push(f)}function Q(){}0&&(module.exports={activate,deactivate});
